<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar System | Pomodoro | To-Do</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        canvas { display: block; }

        /* ============== Panel Base ============== */
        .panel {
            position: fixed;
            background: rgba(20, 25, 40, 0.92);
            border-radius: 12px;
            color: #e0e8ff;
            z-index: 100;
            min-width: 280px;
            max-width: 320px;
            border: 1px solid rgba(100, 120, 180, 0.3);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
            transition: box-shadow 0.2s;
            display: flex;
            flex-direction: column;
        }
        .panel.hidden { display: none !important; }
        .panel.collapsed .panel-content { display: none; }
        .panel.dragging {
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.7);
            z-index: 999 !important;
        }
        .panel.locked .panel-header { cursor: default; }

        /* Panel Header - Drag Handle */
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(100, 120, 180, 0.3);
            cursor: grab;
            user-select: none;
            position: relative;
        }
        .panel-header:active { cursor: grabbing; }
        .panel.locked .panel-header { cursor: default; }
        
        .panel-title {
            font-size: 15px;
            font-weight: 600;
            color: #a0c0ff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .lock-icon {
            font-size: 12px;
            opacity: 0.6;
        }
        .panel-buttons {
            display: flex;
            gap: 6px;
            position: relative;
        }
        .panel-btn {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 1px solid rgba(100, 120, 180, 0.4);
            background: rgba(40, 50, 80, 0.6);
            color: #a0b0d0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }
        .panel-btn:hover {
            background: rgba(60, 80, 120, 0.8);
            color: #fff;
        }

        /* Panel Content */
        .panel-content {
            padding: 15px;
            max-height: 65vh;
            overflow-y: auto;
        }
        .panel-content::-webkit-scrollbar { width: 6px; }
        .panel-content::-webkit-scrollbar-track { background: rgba(30,40,60,0.5); border-radius: 3px; }
        .panel-content::-webkit-scrollbar-thumb { background: rgba(80,100,150,0.6); border-radius: 3px; }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: rgba(25, 30, 50, 0.98);
            border: 1px solid rgba(100, 120, 180, 0.4);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 170px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 200;
            display: none;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 13px;
            color: #c0d0ff;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }
        .dropdown-item:hover { background: rgba(60,80,120,0.5); }
        .dropdown-item.danger { color: #ff8080; }
        .dropdown-divider { height: 1px; background: rgba(100,120,180,0.3); margin: 8px 0; }

        /* Form Elements */
        .control-group { margin-bottom: 12px; }
        .control-group:last-child { margin-bottom: 0; }
        .control-label {
            display: block; font-size: 11px; color: #8090b0;
            margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .control-row { display: flex; align-items: center; gap: 6px; }
        
        input[type="number"], input[type="text"], input[type="date"] {
            padding: 6px 10px;
            border: 1px solid rgba(100,120,180,0.4);
            border-radius: 5px;
            background: rgba(30,40,60,0.8);
            color: #c0d0ff;
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        input:focus { outline: none; border-color: #4080c0; }
        input[type="number"] { width: 70px; text-align: center; }
        input.input-sm { width: 50px; padding: 5px 6px; font-size: 12px; }
        input.input-lg { width: 100%; }

        /* Buttons */
        .btn {
            padding: 8px 14px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 12px; font-weight: 500;
            font-family: inherit; transition: all 0.2s;
            display: inline-flex; align-items: center; justify-content: center;
            gap: 5px; white-space: nowrap;
        }
        .btn-primary { background: linear-gradient(135deg,#3060a0,#4080c0); color: #fff; }
        .btn-primary:hover { background: linear-gradient(135deg,#4080c0,#50a0e0); }
        .btn-secondary { background: rgba(60,80,120,0.5); color: #c0d0ff; }
        .btn-secondary:hover { background: rgba(80,100,150,0.6); }
        .btn-success { background: linear-gradient(135deg,#30a060,#40c080); color: #fff; }
        .btn-warning { background: linear-gradient(135deg,#a07030,#c09040); color: #fff; }
        .btn-danger { background: linear-gradient(135deg,#a03030,#c04040); color: #fff; }
        .btn-sm { padding: 5px 10px; font-size: 11px; }
        .btn-xs { padding: 4px 8px; font-size: 11px; }
        .btn-fixed { min-width: 100px; }
        .btn-row { display: flex; gap: 6px; }
        .btn-row .btn { flex: 1; }

        /* Toggle */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; }
        .toggle-row span { font-size: 13px; color: #c0d0ff; }
        .toggle {
            width: 40px; height: 22px; background: rgba(60,80,120,0.5);
            border-radius: 11px; position: relative; cursor: pointer; transition: background 0.3s;
        }
        .toggle.active { background: linear-gradient(135deg,#3080c0,#40a0e0); }
        .toggle::after {
            content: ''; position: absolute; width: 18px; height: 18px;
            background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: left 0.3s;
        }
        .toggle.active::after { left: 20px; }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }
        input[type="number"] { -moz-appearance: textfield; }

        /* ============== Solar Panel ============== */
        .date-display {
            background: rgba(30,40,60,0.6); border-radius: 8px;
            padding: 10px; margin-bottom: 12px; text-align: center;
        }
        .date-main { font-size: 18px; font-weight: bold; color: #fff; margin-bottom: 4px; }
        .date-time { font-size: 12px; color: #8090b0; }
        .date-buttons { display: flex; gap: 4px; margin-top: 8px; justify-content: center; flex-wrap: wrap; }

        /* ============== Pomodoro ============== */
        .timer-display { text-align: center; padding: 15px 0; }
        .timer-time {
            font-size: 52px; font-weight: bold; color: #fff;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 30px rgba(100,150,255,0.4); letter-spacing: 2px;
        }
        .timer-status { font-size: 14px; color: #a0c0ff; margin-top: 8px; }
        .timer-status.focusing { color: #ff9080; }
        .timer-status.resting { color: #80ff90; }
        .progress-bar { width: 100%; height: 6px; background: rgba(60,80,120,0.5); border-radius: 3px; overflow: hidden; margin: 12px 0; }
        .progress-fill { height: 100%; background: linear-gradient(90deg,#4080c0,#60a0e0); border-radius: 3px; transition: width 0.5s; }
        .progress-fill.focusing { background: linear-gradient(90deg,#c06050,#e08070); }
        .progress-fill.resting { background: linear-gradient(90deg,#50c060,#70e080); }
        .pomodoro-count { text-align: center; font-size: 28px; margin: 10px 0; color: #ff6b6b; }
        .pomodoro-count span { color: #c0d0ff; font-size: 18px; }
        .time-settings { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .time-setting { text-align: center; }
        .time-setting label { display: block; font-size: 10px; color: #8090b0; margin-bottom: 4px; }
        .time-setting input { width: 100%; text-align: center; }

        /* ============== To-Do ============== */
        .tabs { display: flex; border-bottom: 1px solid rgba(100,120,180,0.3); margin: -15px -15px 15px -15px; padding: 0 10px; }
        .tab { padding: 10px 12px; font-size: 12px; color: #8090b0; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .tab:hover { color: #c0d0ff; }
        .tab.active { color: #60a0ff; border-bottom-color: #60a0ff; }
        .todo-input-row { display: flex; gap: 6px; margin-bottom: 12px; }
        .todo-input { flex: 1; }
        .todo-list { min-height: 80px; max-height: 220px; overflow-y: auto; }
        .todo-item { display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: rgba(30,40,60,0.4); border-radius: 6px; margin-bottom: 6px; transition: all 0.2s; }
        .todo-item:hover { background: rgba(40,50,70,0.6); }
        .todo-item.completed { opacity: 0.5; }
        .todo-item.completed .todo-text { text-decoration: line-through; color: #6080a0; }
        .todo-priority { width: 14px; height: 14px; border-radius: 50%; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .todo-priority:hover { transform: scale(1.2); box-shadow: 0 0 8px currentColor; }
        .todo-priority.high { background: #ff6060; color: #ff6060; }
        .todo-priority.medium { background: #ffb040; color: #ffb040; }
        .todo-priority.low { background: #60d060; color: #60d060; }
        .todo-checkbox { width: 18px; height: 18px; border: 2px solid rgba(100,120,180,0.5); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .todo-checkbox:hover { border-color: #60a0ff; }
        .todo-checkbox.checked { background: #60a0ff; border-color: #60a0ff; }
        .todo-checkbox.checked::after { content: '‚úì'; color: #fff; font-size: 12px; }
        .todo-text { flex: 1; font-size: 13px; color: #d0e0ff; word-break: break-word; }
        .todo-delete { width: 22px; height: 22px; border: none; background: transparent; color: #606080; cursor: pointer; border-radius: 4px; font-size: 14px; opacity: 0; transition: all 0.2s; }
        .todo-item:hover .todo-delete { opacity: 1; }
        .todo-delete:hover { background: rgba(200,60,60,0.3); color: #ff8080; }
        .todo-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 10px; border-top: 1px solid rgba(100,120,180,0.2); }
        .todo-stats { font-size: 12px; color: #8090b0; }
        .todo-empty { text-align: center; padding: 30px; color: #6080a0; font-size: 13px; }

        /* ============== Quote Section ============== */
        .quote-section {
            position: fixed; bottom: 70px; left: 50%; transform: translateX(-50%);
            text-align: center; padding: 12px 20px; max-width: 650px; width: 90%;
            border-radius: 12px; transition: all 0.3s; z-index: 50;
        }
        .quote-section:hover { background: rgba(20,25,40,0.85); border: 1px solid rgba(100,120,180,0.3); }
        .quote-text { font-size: 16px; color: rgba(200,210,230,0.9); line-height: 1.5; font-style: italic; }
        .quote-controls { margin-top: 12px; display: flex; justify-content: center; gap: 8px; opacity: 0; transition: opacity 0.3s; }
        .quote-section:hover .quote-controls { opacity: 1; }
        .quote-input-area { display: none; margin-top: 12px; gap: 8px; }
        .quote-input-area.show { display: flex; }
        .quote-input-area input { flex: 1; }
        .quote-saved-list { display: none; margin-top: 10px; max-height: 120px; overflow-y: auto; background: rgba(30,40,60,0.6); border-radius: 6px; padding: 8px; }
        .quote-saved-list.show { display: block; }
        .quote-saved-item { padding: 6px 10px; font-size: 12px; color: #a0b0d0; cursor: pointer; border-radius: 4px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .quote-saved-item:hover { background: rgba(60,80,120,0.5); }
        .quote-saved-delete { color: #ff6060; padding: 2px 6px; opacity: 0; transition: opacity 0.2s; }
        .quote-saved-item:hover .quote-saved-delete { opacity: 1; }

        /* ============== Tip Footer ============== */
        .tip-footer { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); font-size: 12px; color: rgba(150,160,180,0.6); z-index: 50; }
        .tip-footer a { color: rgba(180,190,210,0.8); text-decoration: underline; cursor: pointer; transition: color 0.2s; }
        .tip-footer a:hover { color: #fff; }

        /* ============== Modals ============== */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: rgba(25,30,50,0.98); padding: 30px; border-radius: 16px; border: 1px solid rgba(100,120,180,0.4); box-shadow: 0 8px 40px rgba(0,0,0,0.5); text-align: center; max-width: 420px; animation: modalIn 0.25s; }
        @keyframes modalIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-title { font-size: 24px; color: #fff; margin-bottom: 12px; }
        .modal-message { font-size: 15px; color: #a0b0d0; margin-bottom: 25px; line-height: 1.5; }
        .modal-buttons { display: flex; flex-direction: column; gap: 10px; }
        .modal-buttons .btn { padding: 12px 20px; font-size: 14px; }

        .tip-modal-content { max-width: 380px; }
        .tip-qr-container { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        .tip-qr-item { text-align: center; }
        .tip-qr-item img { width: 140px; height: 140px; border-radius: 8px; background: #fff; padding: 5px; }
        .tip-qr-item p { font-size: 12px; color: #8090b0; margin-top: 8px; }
        .tip-thanks { font-size: 14px; color: #a0c0ff; margin-top: 15px; line-height: 1.6; }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <!-- Solar System Panel -->
    <div id="solar-panel" class="panel" style="left:20px;top:20px;">
        <div class="panel-header" data-panel="solar-panel">
            <div class="panel-title"><span class="lock-icon" id="solar-lock"></span>üåå Solar System</div>
            <div class="panel-buttons">
                <button class="panel-btn" onclick="toggleCollapse('solar-panel')" title="Collapse">‚àí</button>
                <button class="panel-btn" onclick="toggleMenu('solar-menu')" title="Menu">‚ãÆ</button>
                <div id="solar-menu" class="dropdown-menu">
                    <div class="dropdown-item" onclick="toggleLock('solar-panel')"><span id="solar-lock-text">üîì Lock Position</span></div>
                    <div class="dropdown-item" onclick="resetPosition('solar-panel')">üìç Reset Position</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item danger" onclick="closePanel('solar-panel')">‚úï Close Panel</div>
                </div>
            </div>
        </div>
        <div class="panel-content">
            <div class="date-display">
                <div class="date-main" id="currentDate">2025-01-15</div>
                <div class="date-time" id="currentTime">12:00 UTC</div>
                <div class="date-buttons">
                    <button class="btn btn-xs btn-secondary" onclick="adjustDate(-30)">‚àíM</button>
                    <button class="btn btn-xs btn-secondary" onclick="adjustDate(-1)">‚àíD</button>
                    <button class="btn btn-xs btn-primary" onclick="goToToday()">Today</button>
                    <button class="btn btn-xs btn-secondary" onclick="adjustDate(1)">+D</button>
                    <button class="btn btn-xs btn-secondary" onclick="adjustDate(30)">+M</button>
                </div>
                <div class="date-buttons" style="margin-top:6px;">
                    <button class="btn btn-xs btn-secondary" onclick="showDatePicker()">üìÖ Set Date</button>
                </div>
            </div>
            <div class="control-group">
                <div class="control-label">Time Scale (days/sec)</div>
                <div class="control-row">
                    <input type="number" id="timeScaleInput" value="50" step="any">
                    <span style="color:#6080a0;font-size:10px;">Step</span>
                    <input type="number" id="timeStepInput" class="input-sm" value="10" step="any">
                    <button class="btn btn-xs btn-primary" onclick="changeTimeScale(-1)">‚àí</button>
                    <button class="btn btn-xs btn-primary" onclick="changeTimeScale(1)">+</button>
                </div>
                <div class="date-buttons" style="margin-top:6px;">
                    <button class="btn btn-xs btn-secondary" onclick="setTimeScalePreset(0.00001)">Real</button>
                    <button class="btn btn-xs btn-secondary" onclick="setTimeScalePreset(1)">1√ó</button>
                    <button class="btn btn-xs btn-secondary" onclick="setTimeScalePreset(50)">50√ó</button>
                    <button class="btn btn-xs btn-secondary" onclick="setTimeScalePreset(1000)">1K√ó</button>
                </div>
            </div>
            <div class="control-group">
                <div class="control-label">Zoom Level</div>
                <div class="control-row">
                    <input type="number" id="zoomInput" value="1.00" step="0.1">
                    <span style="color:#6080a0;font-size:10px;">Step</span>
                    <input type="number" id="zoomStepInput" class="input-sm" value="0.5" step="0.1">
                    <button class="btn btn-xs btn-primary" onclick="changeZoom(-1)">‚àí</button>
                    <button class="btn btn-xs btn-primary" onclick="changeZoom(1)">+</button>
                </div>
            </div>
            <div class="control-group">
                <div class="btn-row">
                    <button class="btn btn-warning btn-fixed" id="pauseBtn" onclick="togglePause()">‚è∏ Pause</button>
                    <button class="btn btn-secondary btn-fixed" onclick="resetSolarSystem()">‚Ü∫ Reset</button>
                </div>
            </div>
            <div class="control-group">
                <div class="toggle-row"><span>Show Labels</span><div class="toggle active" id="toggleLabels" onclick="toggleLabels()"></div></div>
                <div class="toggle-row"><span>Show Orbits</span><div class="toggle active" id="toggleOrbits" onclick="toggleOrbits()"></div></div>
            </div>
        </div>
    </div>

    <!-- Pomodoro Panel -->
    <div id="pomodoro-panel" class="panel" style="left:20px;bottom:100px;">
        <div class="panel-header" data-panel="pomodoro-panel">
            <div class="panel-title"><span class="lock-icon" id="pomodoro-lock"></span>üçÖ Pomodoro</div>
            <div class="panel-buttons">
                <button class="panel-btn" onclick="toggleCollapse('pomodoro-panel')" title="Collapse">‚àí</button>
                <button class="panel-btn" onclick="toggleMenu('pomodoro-menu')" title="Menu">‚ãÆ</button>
                <div id="pomodoro-menu" class="dropdown-menu">
                    <div class="dropdown-item" onclick="toggleLock('pomodoro-panel')"><span id="pomodoro-lock-text">üîì Lock Position</span></div>
                    <div class="dropdown-item" onclick="resetPosition('pomodoro-panel')">üìç Reset Position</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item danger" onclick="closePanel('pomodoro-panel')">‚úï Close Panel</div>
                </div>
            </div>
        </div>
        <div class="panel-content">
            <div class="timer-display">
                <div class="timer-time" id="timerDisplay">25:00</div>
                <div class="timer-status" id="timerStatus">Ready to focus</div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:100%"></div></div>
            <div class="pomodoro-count">üçÖ <span id="pomodoroCount">√ó 0</span></div>
            <div class="time-settings">
                <div class="time-setting"><label>Focus</label><input type="number" id="focusTime" value="25" min="1" max="120"></div>
                <div class="time-setting"><label>Short</label><input type="number" id="shortBreakTime" value="5" min="1" max="30"></div>
                <div class="time-setting"><label>Long</label><input type="number" id="longBreakTime" value="15" min="1" max="60"></div>
            </div>
            <div class="btn-row" style="margin-bottom:8px;">
                <button class="btn btn-success btn-fixed" id="pomodoroStartBtn" onclick="togglePomodoro()">‚ñ∂ Start</button>
                <button class="btn btn-secondary" onclick="skipPomodoro()">‚è≠ Skip</button>
                <button class="btn btn-secondary btn-xs" onclick="resetPomodoro()">‚Ü∫</button>
            </div>
            <div class="btn-row"><button class="btn btn-secondary btn-sm" onclick="resetPomodoroCount()">Reset Count</button></div>
        </div>
    </div>

    <!-- To-Do Panel -->
    <div id="todo-panel" class="panel" style="right:20px;top:20px;">
        <div class="panel-header" data-panel="todo-panel">
            <div class="panel-title"><span class="lock-icon" id="todo-lock"></span>üìù To-Do List</div>
            <div class="panel-buttons">
                <button class="panel-btn" onclick="toggleCollapse('todo-panel')" title="Collapse">‚àí</button>
                <button class="panel-btn" onclick="toggleMenu('todo-menu')" title="Menu">‚ãÆ</button>
                <div id="todo-menu" class="dropdown-menu">
                    <div class="dropdown-item" onclick="toggleLock('todo-panel')"><span id="todo-lock-text">üîì Lock Position</span></div>
                    <div class="dropdown-item" onclick="resetPosition('todo-panel')">üìç Reset Position</div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item danger" onclick="closePanel('todo-panel')">‚úï Close Panel</div>
                </div>
            </div>
        </div>
        <div class="panel-content">
            <div class="tabs">
                <div class="tab active" data-tab="today" onclick="switchTab('today')">Today</div>
                <div class="tab" data-tab="tomorrow" onclick="switchTab('tomorrow')">Tomorrow</div>
                <div class="tab" data-tab="week" onclick="switchTab('week')">Week</div>
                <div class="tab" data-tab="month" onclick="switchTab('month')">Month</div>
            </div>
            <div class="todo-input-row">
                <input type="text" id="todoInput" class="todo-input input-lg" placeholder="Add a task..." onkeypress="if(event.key==='Enter')addTodo()">
                <button class="btn btn-primary btn-sm" onclick="addTodo()">+</button>
            </div>
            <div class="todo-list" id="todoList"></div>
            <div class="todo-footer">
                <div class="todo-stats" id="todoStats">0/0 completed</div>
                <button class="btn btn-secondary btn-sm" onclick="clearCompleted()">Clear Done</button>
            </div>
        </div>
    </div>

    <!-- Quote Section -->
    <div class="quote-section" id="quoteSection">
        <div class="quote-text" id="quoteText">Believe you can and you're halfway there.</div>
        <div class="quote-controls">
            <button class="btn btn-sm btn-secondary" onclick="randomQuote()">üîÄ Random</button>
            <button class="btn btn-sm btn-secondary" onclick="toggleQuoteInput()">‚úèÔ∏è Custom</button>
            <button class="btn btn-sm btn-secondary" onclick="toggleSavedQuotes()">üìö My Quotes</button>
        </div>
        <div class="quote-input-area" id="quoteInputArea">
            <input type="text" id="customQuoteInput" class="input-lg" placeholder="Enter your motivational quote...">
            <button class="btn btn-sm btn-primary" onclick="saveCustomQuote()">Save</button>
        </div>
        <div class="quote-saved-list" id="quoteSavedList"></div>
    </div>

    <!-- Tip Footer -->
    <div class="tip-footer">If you find this useful, consider <a onclick="showTipModal()">buying me a coffee</a> ‚òï</div>

    <!-- Modals -->
    <div class="modal-overlay" id="pomodoroModal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">üéâ Complete!</div>
            <div class="modal-message" id="modalMessage">Great job!</div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

    <div class="modal-overlay" id="datePickerModal">
        <div class="modal-content">
            <div class="modal-title">üìÖ Set Date</div>
            <input type="date" id="datePickerInput" style="width:100%;padding:12px;font-size:16px;margin-bottom:20px;border-radius:8px;border:1px solid rgba(100,120,180,0.4);background:rgba(30,40,60,0.8);color:#c0d0ff;">
            <div class="btn-row">
                <button class="btn btn-primary" onclick="applyDatePicker()">Apply</button>
                <button class="btn btn-secondary" onclick="hideDatePicker()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="tipModal">
        <div class="modal-content tip-modal-content">
            <div class="modal-title">‚òï Support the Author</div>
            <div class="tip-qr-container">
                <div class="tip-qr-item">
                    <img src="./wechat-pay.png" alt="WeChat Pay" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22140%22 height=%22140%22><rect fill=%22%23333%22 width=%22140%22 height=%22140%22/><text x=%2270%22 y=%2270%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23666%22 font-size=%2212%22>WeChat Pay</text></svg>'">
                    <p>Tip via WeChat</p>
                </div>
                <div class="tip-qr-item">
                    <img src="./wechat-qr.png" alt="Add WeChat" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22140%22 height=%22140%22><rect fill=%22%23333%22 width=%22140%22 height=%22140%22/><text x=%2270%22 y=%2270%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23666%22 font-size=%2212%22>Add WeChat</text></svg>'">
                    <p>Add me on WeChat</p>
                </div>
            </div>
            <div class="tip-thanks">Thank you for your support! üôè<br>Your kindness keeps me motivated.</div>
            <div style="margin-top:20px;"><button class="btn btn-secondary" onclick="hideTipModal()">Close</button></div>
        </div>
    </div>

<script>
// ================================================================
// DATA
// ================================================================
const AU_KM = 149597870.7;
const J2000 = Date.UTC(2000, 0, 1, 12, 0, 0);
const MS_PER_DAY = 86400000;

const PLANETS = [
    { name: "Mercury", a: 0.387098, e: 0.205630, L0: 252.251, w: 77.456, T: 87.969, r: 2439.7, c: "#B5A7A7" },
    { name: "Venus", a: 0.723332, e: 0.006772, L0: 181.980, w: 131.564, T: 224.701, r: 6051.8, c: "#E6C87A" },
    { name: "Earth", a: 1.000000, e: 0.016709, L0: 100.465, w: 102.937, T: 365.256, r: 6371.0, c: "#6B93D6" },
    { name: "Mars", a: 1.523679, e: 0.093400, L0: 355.453, w: 336.041, T: 686.980, r: 3389.5, c: "#C1440E" },
    { name: "Jupiter", a: 5.202600, e: 0.048900, L0: 34.396, w: 14.331, T: 4332.59, r: 69911.0, c: "#D8CA9D" },
    { name: "Saturn", a: 9.554909, e: 0.056500, L0: 50.077, w: 93.057, T: 10759.22, r: 58232.0, c: "#F4D59E" },
    { name: "Uranus", a: 19.21845, e: 0.047200, L0: 314.055, w: 173.005, T: 30688.5, r: 25362.0, c: "#D1E7E7" },
    { name: "Neptune", a: 30.11039, e: 0.008600, L0: 304.349, w: 48.124, T: 60182.0, r: 24622.0, c: "#5B5DDF" }
];

const QUOTES = [
    "The only way to do great work is to love what you do. ‚Äì Steve Jobs",
    "Believe you can and you're halfway there. ‚Äì Theodore Roosevelt",
    "It does not matter how slowly you go as long as you do not stop. ‚Äì Confucius",
    "Success is not final, failure is not fatal: it is the courage to continue that counts. ‚Äì Winston Churchill",
    "The future belongs to those who believe in the beauty of their dreams. ‚Äì Eleanor Roosevelt",
    "Don't watch the clock; do what it does. Keep going. ‚Äì Sam Levenson",
    "Everything you've ever wanted is on the other side of fear. ‚Äì George Addair",
    "Hardships often prepare ordinary people for an extraordinary destiny. ‚Äì C.S. Lewis",
    "The secret of getting ahead is getting started. ‚Äì Mark Twain",
    "Your limitation‚Äîit's only your imagination.",
    "Push yourself, because no one else is going to do it for you.",
    "Great things never come from comfort zones.",
    "Dream it. Wish it. Do it.",
    "Success doesn't just find you. You have to go out and get it.",
    "The harder you work for something, the greater you'll feel when you achieve it.",
    "Don't stop when you're tired. Stop when you're done.",
    "Wake up with determination. Go to bed with satisfaction.",
    "Do something today that your future self will thank you for.",
    "Little things make big days.",
    "It's going to be hard, but hard does not mean impossible."
];

const DEFAULT_POS = {
    'solar-panel': { left: 20, top: 20 },
    'pomodoro-panel': { left: 20, bottom: 100 },
    'todo-panel': { right: 20, top: 20 }
};

// ================================================================
// STATE
// ================================================================
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let timeScale = 50, zoom = 1.0, isPaused = false, showLabels = true, showOrbits = true;
let simDate = Date.now(), lastFrame = 0;
let stars = [];

let panelState = {
    'solar-panel': { collapsed: false, locked: false, closed: false, pos: { left: 20, top: 20 } },
    'pomodoro-panel': { collapsed: false, locked: false, closed: false, pos: { left: 20, bottom: 100 } },
    'todo-panel': { collapsed: false, locked: false, closed: false, pos: { right: 20, top: 20 } }
};

let pomodoro = { running: false, mode: 'focus', remaining: 1500, total: 1500, count: 0, interval: null };
let audioCtx = null;

let todos = { today: [], tomorrow: [], week: [], month: [] };
let currentTab = 'today';

let currentQuote = '', savedQuotes = [];

// Drag state
let dragPanel = null, dragOffset = { x: 0, y: 0 };

// ================================================================
// KEPLER
// ================================================================
function solveKepler(M, e) {
    M = ((M % (2*Math.PI)) + 2*Math.PI) % (2*Math.PI);
    let E = M;
    for (let i = 0; i < 30; i++) {
        const dE = (E - e*Math.sin(E) - M) / (1 - e*Math.cos(E));
        E -= dE;
        if (Math.abs(dE) < 1e-10) break;
    }
    return E;
}

function getPos(p, date) {
    const days = (date - J2000) / MS_PER_DAY;
    const M = ((p.L0 - p.w) * Math.PI/180) + (2*Math.PI/p.T) * days;
    const E = solveKepler(M, p.e);
    return { x: p.a * (Math.cos(E) - p.e), y: p.a * Math.sqrt(1-p.e*p.e) * Math.sin(E) };
}

// ================================================================
// RENDER
// ================================================================
function genStars() {
    stars = Array.from({length:300}, () => ({ x:Math.random(), y:Math.random(), b:0.3+Math.random()*0.7, s:0.5+Math.random()*1.5 }));
}

function draw() {
    const W = canvas.width, H = canvas.height;
    const g = ctx.createRadialGradient(W/2,H/2,0,W/2,H/2,Math.max(W,H));
    g.addColorStop(0,'#0a0a15'); g.addColorStop(0.5,'#050510'); g.addColorStop(1,'#000005');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
    stars.forEach(s => { ctx.beginPath(); ctx.arc(s.x*W,s.y*H,s.s,0,Math.PI*2); ctx.fillStyle=`rgba(255,255,255,${s.b})`; ctx.fill(); });

    const sc = 12 * zoom, cx = W/2, cy = H/2;
    const sunR = Math.max(0.723332/15 * sc, 4);

    // Sun glow
    for (let i=5;i>=1;i--) {
        const gr=sunR*(1+i*0.8), gg=ctx.createRadialGradient(cx,cy,sunR*0.5,cx,cy,gr);
        gg.addColorStop(0,`rgba(255,200,100,${0.15/i})`); gg.addColorStop(0.5,`rgba(255,150,50,${0.1/i})`); gg.addColorStop(1,'rgba(255,100,0,0)');
        ctx.beginPath(); ctx.arc(cx,cy,gr,0,Math.PI*2); ctx.fillStyle=gg; ctx.fill();
    }
    const sg=ctx.createRadialGradient(cx-sunR*0.3,cy-sunR*0.3,0,cx,cy,sunR);
    sg.addColorStop(0,'#FFF'); sg.addColorStop(0.2,'#FFF8E0'); sg.addColorStop(0.5,'#FFE080'); sg.addColorStop(0.8,'#FFB020'); sg.addColorStop(1,'#FF8000');
    ctx.beginPath(); ctx.arc(cx,cy,sunR,0,Math.PI*2); ctx.fillStyle=sg; ctx.fill();

    // Orbits
    if (showOrbits) PLANETS.forEach(p => {
        const a=p.a*sc, b=a*Math.sqrt(1-p.e*p.e), c=a*p.e;
        ctx.beginPath(); ctx.strokeStyle='rgba(100,120,160,0.35)'; ctx.lineWidth=1;
        ctx.ellipse(cx-c,cy,a,b,0,0,Math.PI*2); ctx.stroke();
    });

    // Planets
    PLANETS.forEach(p => {
        const pos = getPos(p, simDate);
        const px = cx + pos.x*sc, py = cy - pos.y*sc;
        const pr = Math.max((p.r/AU_KM)*sc, 2.5);

        // Saturn rings
        if (p.name==='Saturn' && pr>3) {
            ['rgba(210,190,150,0.7)','rgba(180,160,120,0.5)','rgba(200,180,140,0.6)','rgba(160,140,100,0.4)'].forEach((col,i) => {
                const ri=pr*1.4, w=(pr*2.3-ri)/4;
                ctx.beginPath(); ctx.arc(px,py,ri+(i+1)*w*0.8,0,Math.PI*2); ctx.arc(px,py,ri+i*w,Math.PI*2,0,true);
                ctx.fillStyle=col; ctx.fill();
            });
        }

        const rgb = parseInt(p.c.slice(1),16);
        const r=(rgb>>16)&255, gg=(rgb>>8)&255, bb=rgb&255;
        const pg = ctx.createRadialGradient(px-pr*0.35,py-pr*0.35,pr*0.1,px,py,pr);
        pg.addColorStop(0,`rgb(${Math.min(255,r+60)},${Math.min(255,gg+60)},${Math.min(255,bb+60)})`);
        pg.addColorStop(0.4,p.c);
        pg.addColorStop(1,`rgb(${Math.max(0,r-50)},${Math.max(0,gg-50)},${Math.max(0,bb-50)})`);
        ctx.beginPath(); ctx.arc(px,py,pr,0,Math.PI*2); ctx.fillStyle=pg; ctx.fill();

        if (showLabels) { ctx.font='12px "Segoe UI",sans-serif'; ctx.fillStyle='rgba(200,210,230,0.9)'; ctx.textAlign='center'; ctx.fillText(p.name,px,py-pr-8); }
    });
}

function render(ts) {
    if (!lastFrame) lastFrame = ts;
    const dt = (ts - lastFrame) / 1000;
    lastFrame = ts;
    if (!isPaused) simDate += dt * timeScale * MS_PER_DAY;
    updateDateDisplay();
    draw();
    requestAnimationFrame(render);
}

// ================================================================
// DATE
// ================================================================
function updateDateDisplay() {
    const d = new Date(simDate);
    document.getElementById('currentDate').textContent = d.toISOString().split('T')[0];
    document.getElementById('currentTime').textContent = d.toISOString().substr(11,5) + ' UTC';
}
function adjustDate(days) { simDate += days * MS_PER_DAY; }
function goToToday() { simDate = Date.now(); }
function showDatePicker() { document.getElementById('datePickerInput').value = new Date(simDate).toISOString().split('T')[0]; document.getElementById('datePickerModal').classList.add('show'); }
function hideDatePicker() { document.getElementById('datePickerModal').classList.remove('show'); }
function applyDatePicker() { const v = document.getElementById('datePickerInput').value; if(v) simDate = new Date(v+'T12:00:00Z').getTime(); hideDatePicker(); }

// ================================================================
// SOLAR CONTROLS
// ================================================================
function fmtTS(v) { return v < 0.01 ? v.toExponential(1) : v < 1 ? v.toFixed(3) : Math.round(v).toString(); }
function changeTimeScale(d) {
    const step = parseFloat(document.getElementById('timeStepInput').value) || 10;
    timeScale = Math.max(0.00001, Math.min(100000, timeScale + d*step));
    document.getElementById('timeScaleInput').value = fmtTS(timeScale);
}
function setTimeScalePreset(v) { timeScale = v; document.getElementById('timeScaleInput').value = fmtTS(v); }
function changeZoom(d) {
    const step = parseFloat(document.getElementById('zoomStepInput').value) || 0.5;
    zoom = Math.max(0.1, Math.min(50, zoom + d*step));
    document.getElementById('zoomInput').value = zoom.toFixed(2);
}
function togglePause() {
    isPaused = !isPaused;
    const btn = document.getElementById('pauseBtn');
    btn.textContent = isPaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
    btn.className = 'btn btn-fixed ' + (isPaused ? 'btn-success' : 'btn-warning');
}
function resetSolarSystem() { timeScale=50; zoom=1; simDate=Date.now(); document.getElementById('timeScaleInput').value='50'; document.getElementById('zoomInput').value='1.00'; }
function toggleLabels() { showLabels=!showLabels; document.getElementById('toggleLabels').classList.toggle('active',showLabels); }
function toggleOrbits() { showOrbits=!showOrbits; document.getElementById('toggleOrbits').classList.toggle('active',showOrbits); }

// ================================================================
// PANEL SYSTEM
// ================================================================
function toggleCollapse(id) {
    const p = document.getElementById(id);
    p.classList.toggle('collapsed');
    p.querySelector('.panel-btn').textContent = p.classList.contains('collapsed') ? '+' : '‚àí';
    panelState[id].collapsed = p.classList.contains('collapsed');
    saveState();
}

function toggleMenu(menuId) {
    const menu = document.getElementById(menuId);
    const open = menu.classList.contains('show');
    closeAllMenus();
    if (!open) menu.classList.add('show');
}
function closeAllMenus() { document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show')); }

function toggleLock(id) {
    panelState[id].locked = !panelState[id].locked;
    const locked = panelState[id].locked;
    document.getElementById(id).classList.toggle('locked', locked);
    document.getElementById(id.replace('-panel','-lock')).textContent = locked ? 'üîí' : '';
    document.getElementById(id.replace('-panel','-lock-text')).textContent = locked ? 'üîì Unlock Position' : 'üîí Lock Position';
    closeAllMenus();
    saveState();
}

function resetPosition(id) {
    const def = DEFAULT_POS[id];
    const p = document.getElementById(id);
    p.style.left = def.left !== undefined ? def.left + 'px' : 'auto';
    p.style.right = def.right !== undefined ? def.right + 'px' : 'auto';
    p.style.top = def.top !== undefined ? def.top + 'px' : 'auto';
    p.style.bottom = def.bottom !== undefined ? def.bottom + 'px' : 'auto';
    panelState[id].pos = { ...def };
    closeAllMenus();
    saveState();
}

function closePanel(id) {
    document.getElementById(id).classList.add('hidden');
    panelState[id].closed = true;
    closeAllMenus();
    saveState();
}

function applyPanelState() {
    for (const id of Object.keys(panelState)) {
        const s = panelState[id];
        const p = document.getElementById(id);
        if (s.closed) p.classList.add('hidden');
        if (s.collapsed) { p.classList.add('collapsed'); p.querySelector('.panel-btn').textContent = '+'; }
        if (s.locked) { p.classList.add('locked'); document.getElementById(id.replace('-panel','-lock')).textContent='üîí'; document.getElementById(id.replace('-panel','-lock-text')).textContent='üîì Unlock Position'; }
        if (s.pos) {
            p.style.left = s.pos.left !== undefined ? s.pos.left + 'px' : 'auto';
            p.style.right = s.pos.right !== undefined ? s.pos.right + 'px' : 'auto';
            p.style.top = s.pos.top !== undefined ? s.pos.top + 'px' : 'auto';
            p.style.bottom = s.pos.bottom !== undefined ? s.pos.bottom + 'px' : 'auto';
        }
    }
}

// ================================================================
// DRAG
// ================================================================
function initDrag() {
    document.querySelectorAll('.panel-header').forEach(header => {
        header.addEventListener('mousedown', startDrag);
        header.addEventListener('touchstart', startDrag, { passive: false });
    });
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('touchmove', onDrag, { passive: false });
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);
}

function startDrag(e) {
    const panelId = e.currentTarget.dataset.panel;
    if (panelState[panelId].locked) return;
    if (e.target.closest('.panel-btn') || e.target.closest('.dropdown-menu')) return;

    e.preventDefault();
    const panel = document.getElementById(panelId);
    const rect = panel.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;

    dragPanel = panelId;
    dragOffset = { x: clientX - rect.left, y: clientY - rect.top };
    panel.classList.add('dragging');

    // Convert to left/top positioning
    panel.style.left = rect.left + 'px';
    panel.style.top = rect.top + 'px';
    panel.style.right = 'auto';
    panel.style.bottom = 'auto';
}

function onDrag(e) {
    if (!dragPanel) return;
    e.preventDefault();

    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    const panel = document.getElementById(dragPanel);
    const rect = panel.getBoundingClientRect();

    let newX = clientX - dragOffset.x;
    let newY = clientY - dragOffset.y;

    // Boundary check
    newX = Math.max(0, Math.min(window.innerWidth - rect.width, newX));
    newY = Math.max(0, Math.min(window.innerHeight - rect.height, newY));

    panel.style.left = newX + 'px';
    panel.style.top = newY + 'px';
}

function endDrag() {
    if (!dragPanel) return;
    const panel = document.getElementById(dragPanel);
    panel.classList.remove('dragging');

    // Save position
    panelState[dragPanel].pos = {
        left: parseInt(panel.style.left),
        top: parseInt(panel.style.top)
    };
    saveState();
    dragPanel = null;
}

// ================================================================
// POMODORO
// ================================================================
function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
function playSound(type) {
    initAudio();
    const now = audioCtx.currentTime;
    (type==='complete'?[523.25,659.25,783.99,1046.50]:[440,554.37]).forEach((f,i) => {
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination); o.frequency.value=f; o.type='sine';
        g.gain.setValueAtTime(0,now+i*0.15); g.gain.linearRampToValueAtTime(0.25,now+i*0.15+0.05); g.gain.linearRampToValueAtTime(0,now+i*0.15+0.3);
        o.start(now+i*0.15); o.stop(now+i*0.15+0.4);
    });
}

function updatePomodoroUI() {
    const m=Math.floor(pomodoro.remaining/60), s=pomodoro.remaining%60;
    document.getElementById('timerDisplay').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    const pct = (pomodoro.remaining/pomodoro.total)*100;
    const fill = document.getElementById('progressFill');
    fill.style.width = pct+'%';
    fill.className = 'progress-fill' + (pomodoro.mode==='focus'&&pomodoro.running?' focusing':'') + (pomodoro.mode!=='focus'&&pomodoro.running?' resting':'');
    const st = document.getElementById('timerStatus');
    st.textContent = pomodoro.mode==='focus' ? (pomodoro.running?'üî• Focusing...':'Ready to focus') : (pomodoro.running?'‚òï Break time...':'Break ready');
    st.className = 'timer-status' + (pomodoro.mode==='focus'&&pomodoro.running?' focusing':'') + (pomodoro.mode!=='focus'&&pomodoro.running?' resting':'');
    document.getElementById('pomodoroCount').textContent = '√ó ' + pomodoro.count;
}

function togglePomodoro() {
    if (pomodoro.running) { clearInterval(pomodoro.interval); pomodoro.running=false; }
    else {
        initAudio(); pomodoro.running=true;
        pomodoro.interval = setInterval(() => {
            pomodoro.remaining--;
            updatePomodoroUI();
            if (pomodoro.remaining<=0) { clearInterval(pomodoro.interval); pomodoro.running=false; onPomodoroEnd(); }
        }, 1000);
    }
    const btn = document.getElementById('pomodoroStartBtn');
    btn.textContent = pomodoro.running ? '‚è∏ Pause' : '‚ñ∂ Start';
    btn.className = 'btn btn-fixed ' + (pomodoro.running ? 'btn-warning' : 'btn-success');
    updatePomodoroUI();
}

function onPomodoroEnd() {
    if (pomodoro.mode==='focus') { pomodoro.count++; savePomodoroData(); playSound('complete'); showPomodoroModal(pomodoro.count%4===0); }
    else { playSound('break'); showBreakModal(); }
    document.getElementById('pomodoroStartBtn').textContent='‚ñ∂ Start';
    document.getElementById('pomodoroStartBtn').className='btn btn-fixed btn-success';
    updatePomodoroUI();
}

function startFocus() { pomodoro.mode='focus'; pomodoro.remaining=(parseInt(document.getElementById('focusTime').value)||25)*60; pomodoro.total=pomodoro.remaining; updatePomodoroUI(); }
function startBreak(long) { pomodoro.mode=long?'longBreak':'shortBreak'; pomodoro.remaining=(parseInt(document.getElementById(long?'longBreakTime':'shortBreakTime').value)||(long?15:5))*60; pomodoro.total=pomodoro.remaining; updatePomodoroUI(); togglePomodoro(); }
function skipPomodoro() { clearInterval(pomodoro.interval); pomodoro.running=false; pomodoro.mode==='focus'?startBreak(false):startFocus(); document.getElementById('pomodoroStartBtn').textContent='‚ñ∂ Start'; document.getElementById('pomodoroStartBtn').className='btn btn-fixed btn-success'; }
function resetPomodoro() { clearInterval(pomodoro.interval); pomodoro.running=false; startFocus(); document.getElementById('pomodoroStartBtn').textContent='‚ñ∂ Start'; document.getElementById('pomodoroStartBtn').className='btn btn-fixed btn-success'; }
function resetPomodoroCount() { pomodoro.count=0; updatePomodoroUI(); savePomodoroData(); }

function showPomodoroModal(long) {
    const t = parseInt(document.getElementById(long?'longBreakTime':'shortBreakTime').value)||(long?15:5);
    showModal('üéâ Pomodoro Complete!', `You've completed ${pomodoro.count} pomodoro${pomodoro.count>1?'s':''} today!`, [
        { text:`‚òï ${long?'Long':'Short'} Break (${t}min)`, cls:'btn btn-success', fn:()=>startBreak(long) },
        { text:'üî• Skip Break', cls:'btn btn-primary', fn:()=>{startFocus();togglePomodoro();} },
        { text:'‚è∏ Pause', cls:'btn btn-secondary', fn:startFocus }
    ]);
}
function showBreakModal() {
    showModal('‚òï Break Complete!', 'Ready to focus again?', [
        { text:'üî• Start Pomodoro', cls:'btn btn-success', fn:()=>{startFocus();togglePomodoro();} },
        { text:'‚òï +5 Minutes', cls:'btn btn-secondary', fn:()=>{pomodoro.remaining=300;pomodoro.total=300;togglePomodoro();} },
        { text:'‚è∏ Pause', cls:'btn btn-secondary', fn:startFocus }
    ]);
}
function showModal(title, msg, btns) {
    document.getElementById('modalTitle').textContent=title;
    document.getElementById('modalMessage').textContent=msg;
    const c=document.getElementById('modalButtons'); c.innerHTML='';
    btns.forEach(b => { const btn=document.createElement('button'); btn.textContent=b.text; btn.className=b.cls; btn.onclick=()=>{hideModal();if(b.fn)b.fn();}; c.appendChild(btn); });
    document.getElementById('pomodoroModal').classList.add('show');
}
function hideModal() { document.getElementById('pomodoroModal').classList.remove('show'); }

// ================================================================
// TO-DO
// ================================================================
function switchTab(tab) { currentTab=tab; document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab)); renderTodos(); }
function addTodo() { const inp=document.getElementById('todoInput'), text=inp.value.trim(); if(!text)return; todos[currentTab].push({id:Date.now(),text,priority:'medium',completed:false}); inp.value=''; saveTodos(); renderTodos(); }
function toggleTodo(id) { const t=todos[currentTab].find(x=>x.id===id); if(t){t.completed=!t.completed;saveTodos();renderTodos();} }
function cyclePriority(id) { const t=todos[currentTab].find(x=>x.id===id); if(t){t.priority={medium:'high',high:'low',low:'medium'}[t.priority];saveTodos();renderTodos();} }
function deleteTodo(id) { todos[currentTab]=todos[currentTab].filter(x=>x.id!==id); saveTodos(); renderTodos(); }
function clearCompleted() { todos[currentTab]=todos[currentTab].filter(x=>!x.completed); saveTodos(); renderTodos(); }
function renderTodos() {
    const list=document.getElementById('todoList'), items=todos[currentTab];
    if(!items.length) { list.innerHTML='<div class="todo-empty">No tasks yet. Add one above!</div>'; document.getElementById('todoStats').textContent='0/0 completed'; return; }
    const order={high:0,medium:1,low:2};
    const sorted=[...items].sort((a,b)=>a.completed!==b.completed?(a.completed?1:-1):order[a.priority]-order[b.priority]);
    list.innerHTML=sorted.map(t=>`<div class="todo-item ${t.completed?'completed':''}"><div class="todo-priority ${t.priority}" onclick="cyclePriority(${t.id})" title="Click to change"></div><div class="todo-checkbox ${t.completed?'checked':''}" onclick="toggleTodo(${t.id})"></div><div class="todo-text">${esc(t.text)}</div><button class="todo-delete" onclick="deleteTodo(${t.id})">√ó</button></div>`).join('');
    document.getElementById('todoStats').textContent=`${items.filter(x=>x.completed).length}/${items.length} completed`;
}
function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

// ================================================================
// QUOTES
// ================================================================
function initQuote() {
    const saved=localStorage.getItem('currentQuote');
    currentQuote = saved || QUOTES[Math.floor(Math.random()*QUOTES.length)];
    document.getElementById('quoteText').textContent = currentQuote;
    try { savedQuotes=JSON.parse(localStorage.getItem('savedQuotes'))||[]; } catch(e) { savedQuotes=[]; }
}
function randomQuote() {
    const all=[...QUOTES,...savedQuotes];
    let nq; do { nq=all[Math.floor(Math.random()*all.length)]; } while(nq===currentQuote&&all.length>1);
    currentQuote=nq; document.getElementById('quoteText').textContent=currentQuote; localStorage.setItem('currentQuote',currentQuote);
}
function toggleQuoteInput() { document.getElementById('quoteInputArea').classList.toggle('show'); document.getElementById('quoteSavedList').classList.remove('show'); }
function saveCustomQuote() {
    const inp=document.getElementById('customQuoteInput'), text=inp.value.trim(); if(!text)return;
    if(savedQuotes.length>=20)savedQuotes.shift(); savedQuotes.push(text);
    localStorage.setItem('savedQuotes',JSON.stringify(savedQuotes));
    currentQuote=text; document.getElementById('quoteText').textContent=text; localStorage.setItem('currentQuote',text);
    inp.value=''; document.getElementById('quoteInputArea').classList.remove('show'); renderSavedQuotes();
}
function toggleSavedQuotes() { document.getElementById('quoteSavedList').classList.toggle('show'); document.getElementById('quoteInputArea').classList.remove('show'); if(document.getElementById('quoteSavedList').classList.contains('show'))renderSavedQuotes(); }
function renderSavedQuotes() {
    const list=document.getElementById('quoteSavedList');
    if(!savedQuotes.length) { list.innerHTML='<div style="padding:10px;color:#6080a0;font-size:12px;">No saved quotes yet.</div>'; return; }
    list.innerHTML=savedQuotes.map((q,i)=>`<div class="quote-saved-item"><span onclick="selectQuote(${i})">${esc(q.length>50?q.substr(0,50)+'...':q)}</span><span class="quote-saved-delete" onclick="deleteQuote(${i})">√ó</span></div>`).join('');
}
function selectQuote(i) { currentQuote=savedQuotes[i]; document.getElementById('quoteText').textContent=currentQuote; localStorage.setItem('currentQuote',currentQuote); document.getElementById('quoteSavedList').classList.remove('show'); }
function deleteQuote(i) { savedQuotes.splice(i,1); localStorage.setItem('savedQuotes',JSON.stringify(savedQuotes)); renderSavedQuotes(); }

// ================================================================
// TIP MODAL
// ================================================================
function showTipModal() { document.getElementById('tipModal').classList.add('show'); }
function hideTipModal() { document.getElementById('tipModal').classList.remove('show'); }

// ================================================================
// STORAGE
// ================================================================
function saveState() { localStorage.setItem('appState', JSON.stringify(panelState)); }
function loadState() { try { const d=JSON.parse(localStorage.getItem('appState')); if(d) panelState={...panelState,...d}; } catch(e){} applyPanelState(); }
function savePomodoroData() { localStorage.setItem('pomodoroData', JSON.stringify({ count:pomodoro.count, date:new Date().toDateString() })); }
function loadPomodoroData() { try { const d=JSON.parse(localStorage.getItem('pomodoroData')); if(d&&d.date===new Date().toDateString()) pomodoro.count=d.count||0; } catch(e){} pomodoro.remaining=(parseInt(document.getElementById('focusTime').value)||25)*60; pomodoro.total=pomodoro.remaining; updatePomodoroUI(); }
function saveTodos() { localStorage.setItem('todosData', JSON.stringify(todos)); }
function loadTodos() { try { const d=JSON.parse(localStorage.getItem('todosData')); if(d) todos=d; } catch(e){} renderTodos(); }

// ================================================================
// INIT
// ================================================================
function resize() { canvas.width=innerWidth; canvas.height=innerHeight; }

function init() {
    resize(); addEventListener('resize', resize);
    genStars();
    
    document.getElementById('timeScaleInput').addEventListener('change', e => { timeScale=Math.max(0.00001,Math.min(100000,parseFloat(e.target.value)||50)); e.target.value=fmtTS(timeScale); });
    document.getElementById('zoomInput').addEventListener('change', e => { zoom=Math.max(0.1,Math.min(50,parseFloat(e.target.value)||1)); e.target.value=zoom.toFixed(2); });
    canvas.addEventListener('wheel', e => { e.preventDefault(); changeZoom(e.deltaY>0?-1:1); }, {passive:false});
    document.addEventListener('click', e => { if(!e.target.closest('.panel-btn')&&!e.target.closest('.dropdown-menu')) closeAllMenus(); });

    loadState();
    loadPomodoroData();
    loadTodos();
    initQuote();
    initDrag();

    requestAnimationFrame(render);
}

addEventListener('load', init);
</script>
</body>
</html>
